<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire EISI - EPSI/WIS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .alert { display: none; }
        #experienceFields { display: none; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>Formulaire EISI</h2>
        <div id="errorAlert" class="alert alert-danger" role="alert"></div>
        <form id="eisiForm">
            <!-- Informations de base -->
            <div class="mb-3">
                <label for="id_candidat" class="form-label">ID Candidat (IGOR)</label>
                <input type="text" class="form-control" id="id_candidat" required>
            </div>
            <div class="mb-3">
                <label for="identifiant_candidat" class="form-label">Identifiant candidat</label>
                <input type="text" class="form-control" id="identifiant_candidat" required>
            </div>
            <div class="mb-3">
                <label for="campus" class="form-label">Campus</label>
                <select class="form-control" id="campus" required>
                    <option value="">Sélectionner un campus</option>
                    <option value="Paris">Paris</option>
                    <option value="Nantes">Nantes</option>
                    <option value="Angers">Angers</option>
                    <option value="Bordeaux">Bordeaux</option>
                    <option value="Reims">Reims</option>
                    <option value="Toulouse">Toulouse</option>
                    <option value="Auxerre">Auxerre</option>
                    <option value="Lille">Lille</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="civilite" class="form-label">Civilité</label>
                <select class="form-control" id="civilite" required>
                    <option value="Monsieur">Monsieur</option>
                    <option value="Madame">Madame</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="nom" class="form-label">Nom de naissance</label>
                <input type="text" class="form-control" id="nom" required>
            </div>
            <div class="mb-3">
                <label for="prenom" class="form-label">Prénom</label>
                <input type="text" class="form-control" id="prenom" required>
            </div>
            <div class="mb-3">
                <label for="date_naissance" class="form-label">Date de naissance</label>
                <input type="date" class="form-control" id="date_naissance" required>
            </div>
            <div class="mb-3">
                <label for="code_postal_naissance" class="form-label">Code postal ville de naissance</label>
                <input type="text" class="form-control" id="code_postal_naissance" required>
            </div>
            <div class="mb-3">
                <label for="lieu_naissance" class="form-label">Lieu de naissance (Ville)</label>
                <input type="text" class="form-control" id="lieu_naissance" required>
            </div>
            <div class="mb-3">
                <label for="pays_naissance" class="form-label">Pays de naissance</label>
                <input type="text" class="form-control" id="pays_naissance" required>
            </div>
            <div class="mb-3">
                <label for="nationalite" class="form-label">Nationalité</label>
                <input type="text" class="form-control" id="nationalite" required>
            </div>
            <!-- Formation -->
            <div class="mb-3">
                <label for="dernier_diplome" class="form-label">Intitulé du dernier diplôme obtenu</label>
                <input type="text" class="form-control" id="dernier_diplome" required>
            </div>
            <div class="mb-3">
                <label for="niveau_diplome" class="form-label">Niveau du dernier diplôme obtenu</label>
                <input type="text" class="form-control" id="niveau_diplome" required>
            </div>
            <div class="mb-3">
                <label for="annee_diplome" class="form-label">Année d'obtention du dernier diplôme</label>
                <input type="number" class="form-control" id="annee_diplome" required min="1900" max="2025">
            </div>
            <div class="mb-3">
                <label for="decision_jury" class="form-label">Décision du jury</label>
                <select class="form-control" id="decision_jury" required>
                    <option value="">Sélectionner une décision</option>
                    <option value="Admis">Admis</option>
                    <option value="Refusé">Refusé</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="annee_inscription" class="form-label">Année de première inscription dans l'école</label>
                <input type="number" class="form-control" id="annee_inscription" required min="1900" max="2025">
            </div>
            <div class="mb-3">
                <label for="voie_acces" class="form-label">Voie d'accès</label>
                <select class="form-control" id="voie_acces" required>
                    <option value="formation_initiale_hors_alternance">Formation initiale hors alternance</option>
                    <option value="formation_continue_hors_alternance">Formation continue hors alternance</option>
                    <option value="contrat_apprentissage">Contrat d'apprentissage</option>
                    <option value="contrat_professionnalisation">Contrat de professionnalisation</option>
                    <option value="candidat_libre">Candidat libre</option>
                </select>
            </div>
            <!-- Situation et expérience -->
            <div class="mb-3">
                <label for="situation_avant_cursus" class="form-label">Situation avant le cursus</label>
                <select class="form-control" id="situation_avant_cursus" required>
                    <option value="actif_occupe_hors_alternance">Actif occupé hors alternance</option>
                    <option value="recherche_emploi">En recherche d'emploi</option>
                    <option value="en_formation">En formation</option>
                    <option value="inactif">Inactif</option>
                </select>
            </div>
            <div id="experienceFields">
                <div class="mb-3">
                    <label for="dernier_metier" class="form-label">Dernier métier exercé avant le cursus certifiant</label>
                    <input type="text" class="form-control" id="dernier_metier">
                </div>
                <div class="mb-3">
                    <label for="nom_entreprise" class="form-label">Nom de l'entreprise</label>
                    <input type="text" class="form-control" id="nom_entreprise">
                </div>
                <div class="mb-3">
                    <label for="duree_experience" class="form-label">Durée de l'expérience professionnelle (en années)</label>
                    <input type="number" class="form-control" id="duree_experience" min="0">
                </div>
            </div>
            <!-- Coordonnées -->
            <div class="mb-3">
                <label for="tel_mobile" class="form-label">Téléphone portable personnel</label>
                <input type="tel" class="form-control" id="tel_mobile" required pattern="[0-9]{10}" title="Entrez un numéro de téléphone à 10 chiffres">
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Adresse mail personnelle</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <button type="submit" class="btn btn-primary">Soumettre</button>
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById("situation_avant_cursus").addEventListener("change", function() {
            const experienceFields = document.getElementById("experienceFields");
            if (this.value === "actif_occupe_hors_alternance") {
                experienceFields.style.display = "block";
                document.getElementById("dernier_metier").required = true;
                document.getElementById("nom_entreprise").required = true;
                document.getElementById("duree_experience").required = true;
            } else {
                experienceFields.style.display = "none";
                document.getElementById("dernier_metier").required = false;
                document.getElementById("nom_entreprise").required = false;
                document.getElementById("duree_experience").required = false;
            }
        });

        document.getElementById("eisiForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            const errorAlert = document.getElementById("errorAlert");
            errorAlert.style.display = "none";

            const requiredFields = {
                id_candidat: document.getElementById("id_candidat").value.trim(),
                identifiant_candidat: document.getElementById("identifiant_candidat").value.trim(),
                campus: document.getElementById("campus").value,
                civilite: document.getElementById("civilite").value,
                nom: document.getElementById("nom").value.trim(),
                prenom: document.getElementById("prenom").value.trim(),
                date_naissance: document.getElementById("date_naissance").value,
                code_postal_naissance: document.getElementById("code_postal_naissance").value.trim(),
                lieu_naissance: document.getElementById("lieu_naissance").value.trim(),
                pays_naissance: document.getElementById("pays_naissance").value.trim(),
                nationalite: document.getElementById("nationalite").value.trim(),
                dernier_diplome: document.getElementById("dernier_diplome").value.trim(),
                niveau_diplome: document.getElementById("niveau_diplome").value.trim(),
                annee_diplome: document.getElementById("annee_diplome").value,
                decision_jury: document.getElementById("decision_jury").value,
                annee_inscription: document.getElementById("annee_inscription").value,
                voie_acces: document.getElementById("voie_acces").value,
                situation_avant_cursus: document.getElementById("situation_avant_cursus").value,
                tel_mobile: document.getElementById("tel_mobile").value.trim(),
                email: document.getElementById("email").value.trim()
            };

            for (let field in requiredFields) {
                if (!requiredFields[field] || requiredFields[field] === "") {
                    errorAlert.textContent = `Le champ "${field.replace(/_/g, ' ')}" est requis et ne peut pas être vide.`;
                    errorAlert.style.display = "block";
                    return;
                }
            }

            const formData = {
                id_candidat: requiredFields.id_candidat,
                identifiant_candidat: requiredFields.identifiant_candidat,
                campus: requiredFields.campus,
                civilite: requiredFields.civilite,
                nom: requiredFields.nom,
                prenom: requiredFields.prenom,
                date_naissance: requiredFields.date_naissance,
                code_postal_naissance: requiredFields.code_postal_naissance,
                lieu_naissance: requiredFields.lieu_naissance,
                pays_naissance: requiredFields.pays_naissance,
                nationalite: requiredFields.nationalite,
                dernier_diplome: requiredFields.dernier_diplome,
                niveau_diplome: requiredFields.niveau_diplome,
                annee_diplome: parseInt(requiredFields.annee_diplome),
                decision_jury: requiredFields.decision_jury,
                annee_inscription: parseInt(requiredFields.annee_inscription),
                voie_acces: requiredFields.voie_acces,
                situation_avant_cursus: requiredFields.situation_avant_cursus,
                dernier_metier: document.getElementById("dernier_metier").value.trim() || null,
                nom_entreprise: document.getElementById("nom_entreprise").value.trim() || null,
                duree_experience: document.getElementById("duree_experience").value ? parseInt(document.getElementById("duree_experience").value) : null,
                tel_mobile: requiredFields.tel_mobile,
                email: requiredFields.email
            };

            if (isNaN(formData.annee_diplome) || formData.annee_diplome < 1900 || formData.annee_diplome > 2025) {
                errorAlert.textContent = "L'année du diplôme doit être un nombre valide entre 1900 et 2025.";
                errorAlert.style.display = "block";
                return;
            }
            if (isNaN(formData.annee_inscription) || formData.annee_inscription < 1900 || formData.annee_inscription > 2025) {
                errorAlert.textContent = "L'année d'inscription doit être un nombre valide entre 1900 et 2025.";
                errorAlert.style.display = "block";
                return;
            }
            if (formData.duree_experience !== null && (isNaN(formData.duree_experience) || formData.duree_experience < 0)) {
                errorAlert.textContent = "La durée d'expérience doit être un nombre valide et positif.";
                errorAlert.style.display = "block";
                return;
            }

            console.log("Données envoyées à /submit-eisi :", formData);
            try {
                const response = await fetch("/submit-eisi", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formData)
                });
                const data = await response.json();
                console.log("Réponse de /submit-eisi :", response.status, data);
                if (response.ok) {
                    alert(data.message);
                    window.location.href = data.redirect;
                } else {
                    errorAlert.textContent = "Erreur : " + (data.detail || "Une erreur est survenue.");
                    errorAlert.style.display = "block";
                }
            } catch (err) {
                console.error("Erreur réseau ou CORS :", err);
                errorAlert.textContent = "Erreur lors de la soumission : " + (err.message || err);
                errorAlert.style.display = "block";
            }
        });
    </script>
</body>
</html>